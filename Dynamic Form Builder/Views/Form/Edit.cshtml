@model Dynamic_Form_Builder.Models.Form

@{
    ViewData["Title"] = "Edit Form";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h3>Edit Form: @Model.Title</h3>

    <form id="editForm">
        <input type="hidden" id="FormId" value="@Model.FormId" />

        <div class="mb-3">
            <label for="FormTitle" class="form-label">Form Title</label>
            <input id="FormTitle" class="form-control" value="@Model.Title" />
        </div>

        <div id="dropdownContainer">
            @for (int i = 0; i < Model.Fields.Count; i++)
            {
                <div class="dropdown-field border rounded p-3 mb-3">
                    <label class="form-label"><strong>@Model.Fields[i].Label</strong></label>
                    <input type="hidden" class="field-label" value="@Model.Fields[i].Label" />
                    <select class="form-select mb-2 field-select">
                        <option value="">Select Item</option>
                        <option value="Option 1" selected="@(Model.Fields[i].SelectedOption == "Option 1" ? "selected" : null)">Option 1</option>
                        <option value="Option 2" selected="@(Model.Fields[i].SelectedOption == "Option 2" ? "selected" : null)">Option 2</option>
                        <option value="Option 3" selected="@(Model.Fields[i].SelectedOption == "Option 3" ? "selected" : null)">Option 3</option>
                    </select>
                </div>
            }
        </div>

        <!-- Add More button -->
        <button type="button" id="addMoreBtn" class="btn btn-info mb-3">Add More</button>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a asp-action="Index" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            // Initialize field count based on existing dropdown fields
            let fieldIndex = $('#dropdownContainer .dropdown-field').length;

            // Function to add new dropdown field dynamically
            function addDropdown() {
                fieldIndex++;
                const labelText = 'Level ' + fieldIndex;
                const newFieldHtml = `
                    <div class="dropdown-field border rounded p-3 mb-3">
                        <label class="form-label"><strong>${labelText}</strong></label>
                        <input type="hidden" class="field-label" value="${labelText}" />
                        <select class="form-select mb-2 field-select">
                            <option value="">Select Item</option>
                            <option value="Option 1">Option 1</option>
                            <option value="Option 2">Option 2</option>
                            <option value="Option 3">Option 3</option>
                        </select>
                    </div>
                `;
                $('#dropdownContainer').append(newFieldHtml);
            }

            // Bind click on Add More button
            $('#addMoreBtn').click(function () {
                addDropdown();
            });

            // Submit handler for the form
            $('#editForm').submit(function (e) {
                e.preventDefault();

                var formObj = {
                    FormId: parseInt($('#FormId').val()),
                    Title: $('#FormTitle').val().trim(),
                    Fields: []
                };

                $('#dropdownContainer .dropdown-field').each(function () {
                    var label = $(this).find('.field-label').val();
                    var selectedOption = $(this).find('.field-select').val();

                    formObj.Fields.push({
                        Label: label,
                        SelectedOption: selectedOption,
                        IsRequired: false // or remove if your model doesn't use this
                    });
                });

                if (!formObj.Title) {
                    Swal.fire('Error', 'Please enter a form title.', 'error');
                    return;
                }
                if (formObj.Fields.length === 0) {
                    Swal.fire('Error', 'Please add at least one field.', 'error');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("Edit", "Form")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formObj),
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: response.message,
                                timer: 2000,
                                showConfirmButton: false
                            }).then(() => {
                                window.location.href = '@Url.Action("Index", "Form")';
                            });
                        } else {
                            Swal.fire('Error', response.message, 'error');
                        }
                    },
                    error: function () {
                        Swal.fire('Error', 'Something went wrong!', 'error');
                    }
                });
            });
        });
    </script>
}
